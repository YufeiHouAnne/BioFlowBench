import subprocess
import os
from langchain.tools import tool

WORKSPACE_DIR = "/home/houyufei/yfhou/biotoolbenchmark/BioGen_Data/workspace"
SEED_REPO_DIR = "/home/houyufei/yfhou/biotoolbenchmark/BioGen_Data/bio_seeds"

@tool
def get_seed_file_path(filename: str) -> str:
    """
    Returns the full path to a file in the seed repository.
    Use this to get paths for reference genomes, annotations, etc.
    """
    path = os.path.join(SEED_REPO_DIR, filename)
    if not os.path.exists(path):
        raise FileNotFoundError(f"Seed file '{filename}' not found in '{SEED_REPO_DIR}'.")
    return path

@tool
def simulate_metagenome_insilicoseq(
    genome_list_file: str, 
    total_reads: int = 1000000, 
    abundance_model: str = "lognormal"
) -> tuple[str, str]:
    """
    ä½¿ç”¨ InSilicoSeq (iss) æ¨¡æ‹Ÿå®åŸºå› ç»„åŒç«¯ readsã€‚
    éœ€è¦ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯è¡ŒåŒ…å«ä¸€ä¸ªåŸºå› ç»„FASTAæ–‡ä»¶çš„è·¯å¾„ã€‚
    ä¸°åº¦å°†æ ¹æ®æŒ‡å®šçš„æ¨¡å‹ï¼ˆå¦‚'lognormal', 'uniform'ç­‰ï¼‰éšæœºç”Ÿæˆã€‚
    è¿”å›ç”Ÿæˆçš„ä¸¤ä¸ª FASTQ æ–‡ä»¶è·¯å¾„ã€‚
    """
    print(f"ğŸ§¬ Simulating metagenomic reads with InSilicoSeq...")
    
    output_prefix = os.path.join(WORKSPACE_DIR, "iss_metagenome")
    if not os.path.exists(output_prefix):
        os.makedirs(output_prefix)
        
    r1_path = output_prefix + "_R1.fastq"
    r2_path = output_prefix + "_R2.fastq"
    
    # iss generate --genomes <list_file> --n_reads <num> --model wgsim -o <out_prefix> --abundance <model>
    cmd = [
        "conda", "run", "-n", "issenv", "iss", "generate",
        "--genomes", genome_list_file,
        "--n_reads", str(total_reads),
        "--model", "hiseq",  # ä½¿ç”¨ HiSeq æ¨¡å‹
        "--cpus", "4",
        "--quiet",
        "--abundance", abundance_model,
        "-o", output_prefix,
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"InSilicoSeq failed: {result.stderr}")
        
    # InSilicoSeq ç”Ÿæˆçš„æ–‡ä»¶åæ˜¯ prefix_R1.fastq å’Œ prefix_R2.fastq
    print(f"âœ… Metagenomic reads generated by InSilicoSeq at: {r1_path}, {r2_path}")
    return r1_path, r2_path

@tool
def create_genome_list_file(genome_paths: list[str]) -> str:
    """
    åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åŸºå› ç»„åˆ—è¡¨æ–‡ä»¶ï¼Œä¾›InSilicoSeqç­‰å·¥å…·ä½¿ç”¨ã€‚
    genome_paths: ä¸€ä¸ªåŒ…å«ç§å­ä»“åº“ä¸­åŸºå› ç»„æ–‡ä»¶åçš„åˆ—è¡¨ã€‚
    è¿”å›åˆ›å»ºçš„åˆ—è¡¨æ–‡ä»¶çš„è·¯å¾„ã€‚
    """
    file_path = os.path.join(WORKSPACE_DIR, "genome_list.txt")
    with open(file_path, 'w') as f:
        for genome_name in genome_paths:
            # full_path = get_seed_file_path(genome_name) # å¤ç”¨å·²æœ‰çš„å·¥å…·
            full_path = os.path.join(SEED_REPO_DIR, genome_name)
            if not os.path.exists(full_path):
                raise FileNotFoundError(f"Seed file '{genome_name}' not found in '{SEED_REPO_DIR}'.")
            f.write(full_path + '\n')
    print(f"âœ… Created genome list file at: {file_path}")
    return file_path