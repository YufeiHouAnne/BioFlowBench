import subprocess
import os
from langchain.tools import tool

WORKSPACE_DIR = "/home/houyufei/yfhou/biotoolbenchmark/BioGen_Data/workspace"
SEED_REPO_DIR = "/home/houyufei/yfhou/biotoolbenchmark/BioGen_Data/bio_seeds"

@tool
def simulate_rna_seq_reads_art(
    reference_transcriptome_fasta: str, 
    num_reads_per_transcript: int = 50,
    read_length: int = 100
) -> tuple[str, str]:
    """
    ä½¿ç”¨ art_illumina ä»è½¬å½•æœ¬å‚è€ƒåºåˆ—æ¨¡æ‹Ÿ RNA-Seq åŒç«¯ readsã€‚
    è¿™ä¸ªç®€å•æ¨¡å‹ä¸ºæ¯ä¸ªè½¬å½•æœ¬ç”Ÿæˆå›ºå®šæ•°é‡çš„ readsã€‚
    è¿”å›ç”Ÿæˆçš„ä¸¤ä¸ª FASTQ æ–‡ä»¶è·¯å¾„ã€‚
    """
    print(f"ğŸ§¬ Simulating RNA-Seq reads with ART...")
    output_prefix = os.path.join(WORKSPACE_DIR, "art_sim_rna")
    if not os.path.exists(output_prefix):
        os.makedirs(output_prefix)
    r1_path = output_prefix + "1.fq"
    r2_path = output_prefix + "2.fq"
    
    # art_illumina -i <input> -p -l <len> -f <fold_coverage> -m <mean_frag> -s <std_dev_frag> -o <out_prefix>
    cmd = [
        "conda", "run", "-n", "bio_agent_env", "art_illumina",
        "-ss", "HS25",  # ä½¿ç”¨å†…ç½®çš„HiSeq 2500 profile
        "-i", reference_transcriptome_fasta,
        "-p",  # ç”Ÿæˆé…å¯¹æœ«ç«¯ reads
        "-l", str(read_length),
        "-f", str(num_reads_per_transcript), # è¿™é‡Œ 'f' ä»£è¡¨ "fold coverage", è¿‘ä¼¼äºæ¯ä¸ªè½¬å½•æœ¬çš„readsæ•°
        "-m", "300", # å¹³å‡ç‰‡æ®µé•¿åº¦
        "-s", "50",  # ç‰‡æ®µé•¿åº¦æ ‡å‡†å·®
        "-o", output_prefix,
    ]
    print(f"ART command: {' '.join(cmd)}")
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"ART Illumina failed: {result.stderr}\n{result.stdout}")
        
    # ARTç”Ÿæˆçš„æ–‡ä»¶åæ˜¯ prefix + '1.fq' å’Œ '2.fq'
    print(f"âœ… RNA-Seq reads generated by ART at: {r1_path}, {r2_path}")
    return r1_path, r2_path

@tool
def simulate_rna_seq_reads_rsem(
    reference_transcriptome_fasta: str,
    total_reads: int = 1000000
) -> tuple[str, str]:
    """
    ä½¿ç”¨ RSEM çš„ rsem-simulate-reads æ¨¡æ‹Ÿ RNA-Seq åŒç«¯ readsã€‚
    RSEMå¯ä»¥åŸºäºæ¨¡å‹æ–‡ä»¶æ¨¡æ‹Ÿæ›´çœŸå®çš„è¡¨è¾¾åˆ†å¸ƒã€‚æ­¤å·¥å…·å°†ä½¿ç”¨é»˜è®¤çš„å‡åŒ€è¡¨è¾¾ã€‚
    è¿”å›ç”Ÿæˆçš„ä¸¤ä¸ª FASTQ æ–‡ä»¶è·¯å¾„ã€‚
    """
    print("ğŸ§¬ Simulating RNA-Seq reads with RSEM...")
    # RSEMéœ€è¦ä¸€ä¸ªç‰¹å®šçš„å‚è€ƒç´¢å¼•
    ref_name = "rsem_ref"
    ref_path = os.path.join(WORKSPACE_DIR, ref_name)
    # 1. å‡†å¤‡RSEMå‚è€ƒ
    if not os.path.exists(ref_path + ".grp"):
        print(f"â³ Preparing RSEM reference for {reference_transcriptome_fasta}...")
        cmd_prep = ["conda", "run", "-n", "bio_agent_env","rsem-prepare-reference", "--quiet", reference_transcriptome_fasta, ref_path]
        subprocess.run(cmd_prep, check=True)

    # 2. æ¨¡æ‹Ÿ reads
    output_prefix = os.path.join(WORKSPACE_DIR, "rsem_sim")
    if not os.path.exists(output_prefix):
        os.makedirs(output_prefix)
    r1_path = output_prefix + "_1.fq"
    r2_path = output_prefix + "_2.fq"

    # rsem-simulate-reads <ref_name> <model_file> <isoform.results> <theta> <N> <output_name>
    # è¿™é‡Œæˆ‘ä»¬ä¸æä¾›æ¨¡å‹æ–‡ä»¶ï¼ŒRSEMä¼šä½¿ç”¨é»˜è®¤çš„å‡åŒ€åˆ†å¸ƒ
    # `rsem-calculate-expression` çš„è¾“å‡ºå¯ä»¥ä½œä¸ºæ¨¡å‹æ–‡ä»¶ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è·³è¿‡è¿™ä¸€æ­¥
    # æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ isoform.results æ–‡ä»¶å¤´
    isoform_results_path = os.path.join(WORKSPACE_DIR, "dummy.isoforms.results")
    with open(isoform_results_path, 'w') as f:
        f.write("transcript_id\tgene_id\tlength\teffective_length\tFPKM\tTPM\tIsoPct\n")
    
    cmd_sim = [
        "conda", "run", "-n", "bio_agent_env",
        "rsem-simulate-reads",
        ref_path,
        isoform_results_path, # æä¾›ä¸€ä¸ªç©ºçš„ä½†æœ‰å¤´éƒ¨çš„ç»“æœæ–‡ä»¶
        "0.1", # theta value
        str(total_reads),
        output_prefix
    ]
    
    result = subprocess.run(cmd_sim, capture_output=True, text=True)
    if "Can not open" in result.stderr or result.returncode != 0:
        raise RuntimeError(f"RSEM simulation failed: {result.stderr}")

    print(f"âœ… RNA-Seq reads generated by RSEM at: {r1_path}, {r2_path}")
    return r1_path, r2_path